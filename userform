' SOW Builder - Main UserForm Code
' This script creates a comprehensive SOW document based on user input

' Form design variables
Dim currentPage As Integer

' Initialize the form
Private Sub UserForm_Initialize()
    ' Set initial page
    currentPage = 1
    ShowCurrentPage
    
    ' Initialize dropdown for WTW Contracting Party
    With cmbWTWParty
        .AddItem "WTW US"
        .AddItem "WTW Canada"
        .AddItem "WTW UK"
        .AddItem "WTW Australia"
        .AddItem "WTW Other"
    End With
    
    ' Set default values for some fields
    txtDate.Value = Format(Date, "mm/dd/yyyy")
    txtStartDate.Value = Format(Date, "mm/dd/yyyy")
    txtEndDate.Value = Format(DateAdd("yyyy", 1, Date), "mm/dd/yyyy")
    
    ' Initialize other controls
    lstPolicies.Clear
    UpdateCompensationVisibility
End Sub

' Shows the current page based on navigation
Private Sub ShowCurrentPage()
    ' Hide all pages first
    fraPage1.Visible = False
    fraPage2.Visible = False
    fraPage3.Visible = False
    fraPage4.Visible = False
    
    ' Show the current page
    Select Case currentPage
        Case 1
            fraPage1.Visible = True
            btnBack.Enabled = False
            btnNext.Enabled = True
            btnGenerate.Visible = False
        Case 2
            fraPage2.Visible = True
            btnBack.Enabled = True
            btnNext.Enabled = True
            btnGenerate.Visible = False
        Case 3
            fraPage3.Visible = True
            btnBack.Enabled = True
            btnNext.Enabled = True
            btnGenerate.Visible = False
        Case 4
            fraPage4.Visible = True
            btnBack.Enabled = True
            btnNext.Enabled = False
            btnGenerate.Visible = True
    End Select
    
    ' Update form title to show progress
    Me.Caption = "SOW Builder - Page " & currentPage & " of 4"
End Sub

' Navigation buttons
Private Sub btnNext_Click()
    If currentPage < 4 Then
        currentPage = currentPage + 1
        ShowCurrentPage
    End If
End Sub

Private Sub btnBack_Click()
    If currentPage > 1 Then
        currentPage = currentPage - 1
        ShowCurrentPage
    End If
End Sub

' Update visibility of controls based on compensation option selected
Private Sub UpdateCompensationVisibility()
    ' Hide/show fee related controls
    fraFeeDetails.Visible = (optA.Value Or optB.Value Or optC.Value)
    fraBillingOptions.Visible = (optA.Value Or optB.Value Or optC.Value)
    
    ' Hide/show commission related controls
    fraCommissionDetails.Visible = (optB.Value Or optC.Value Or optD.Value)
    
    ' Enable/disable commission list based on option
    If optB.Value Or optC.Value Or optD.Value Then
        txtPolicyName.Enabled = True
        txtCommission.Enabled = True
        btnAddPolicy.Enabled = True
        btnRemovePolicy.Enabled = True
        lstPolicies.Enabled = True
    Else
        txtPolicyName.Enabled = False
        txtCommission.Enabled = False
        btnAddPolicy.Enabled = False
        btnRemovePolicy.Enabled = False
        lstPolicies.Enabled = False
    End If
End Sub

' Compensation option handlers
Private Sub optA_Click()
    UpdateCompensationVisibility
End Sub

Private Sub optB_Click()
    UpdateCompensationVisibility
End Sub

Private Sub optC_Click()
    UpdateCompensationVisibility
End Sub

Private Sub optD_Click()
    UpdateCompensationVisibility
End Sub

' Policy list management
Private Sub btnAddPolicy_Click()
    ' Validate input
    If Trim(txtPolicyName.Value) = "" Then
        MsgBox "Please enter a policy name.", vbExclamation
        txtPolicyName.SetFocus
        Exit Sub
    End If
    
    If Not IsNumeric(txtCommission.Value) Then
        MsgBox "Please enter a valid commission percentage.", vbExclamation
        txtCommission.SetFocus
        Exit Sub
    End If
    
    ' Add to list
    lstPolicies.AddItem txtPolicyName.Value & " (" & txtCommission.Value & "% commission)"
    
    ' Clear inputs
    txtPolicyName.Value = ""
    txtCommission.Value = ""
    txtPolicyName.SetFocus
End Sub

Private Sub btnRemovePolicy_Click()
    If lstPolicies.ListIndex = -1 Then
        MsgBox "Please select a policy to remove.", vbExclamation
    Else
        lstPolicies.RemoveItem lstPolicies.ListIndex
    End If
End Sub

' Document generation
Private Sub btnGenerate_Click()
    ' Validate required fields
    If Not ValidateForm Then Exit Sub
    
    ' Create new document or use template
    Dim doc As Document
    Dim templatePath As String
    
    ' Option to use template or create from scratch
    If chkUseTemplate.Value Then
        templatePath = GetTemplatePath()
        If templatePath = "" Then
            MsgBox "Template path not specified or invalid.", vbExclamation
            Exit Sub
        End If
        Set doc = Documents.Add(Template:=templatePath)
    Else
        Set doc = Documents.Add
    End If
    
    ' Fill document
    FillSOWDocument doc
    
    ' Success message
    MsgBox "SOW document has been generated successfully!", vbInformation
    
    ' Unload form
    Unload Me
End Sub

' Validate all required fields
Private Function ValidateForm() As Boolean
    ' Check client information
    If Trim(txtClientName.Value) = "" Then
        MsgBox "Please enter the Client Legal Name.", vbExclamation
        txtClientName.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    If Trim(txtContactName.Value) = "" Then
        MsgBox "Please enter the Contact Name.", vbExclamation
        txtContactName.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    If cmbWTWParty.ListIndex = -1 Then
        MsgBox "Please select a WTW Contracting Party.", vbExclamation
        cmbWTWParty.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    ' Check dates
    If Not IsDate(txtStartDate.Value) Then
        MsgBox "Please enter a valid Start Date.", vbExclamation
        txtStartDate.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    If Not IsDate(txtEndDate.Value) Then
        MsgBox "Please enter a valid End Date.", vbExclamation
        txtEndDate.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    ' Check compensation options
    If Not (optA.Value Or optB.Value Or optC.Value Or optD.Value) Then
        MsgBox "Please select a compensation option.", vbExclamation
        ValidateForm = False
        Exit Function
    End If
    
    ' Check fee amount if applicable
    If (optA.Value Or optB.Value Or optC.Value) Then
        If Not IsNumeric(txtAnnualFee.Value) Then
            MsgBox "Please enter a valid Annual Fee amount.", vbExclamation
            txtAnnualFee.SetFocus
            ValidateForm = False
            Exit Function
        End If
        
        ' Check billing type selection
        If Not (optMilestone.Value Or optInstallments.Value) Then
            MsgBox "Please select a billing option.", vbExclamation
            ValidateForm = False
            Exit Function
        End If
    End If
    
    ' Check policy list if applicable
    If (optB.Value Or optC.Value Or optD.Value) And lstPolicies.ListCount = 0 Then
        MsgBox "Please add at least one policy with commission rate.", vbExclamation
        txtPolicyName.SetFocus
        ValidateForm = False
        Exit Function
    End If
    
    ' All validations passed
    ValidateForm = True
End Function

' Optional template selection
Private Function GetTemplatePath() As String
    ' This could be a fixed path or use FileDialog to let user select
    ' For now, we'll use a simple input box
    GetTemplatePath = InputBox("Enter the full path to your SOW template:", "Template Selection")
End Function

' Fill the document with all the user input
Private Sub FillSOWDocument(doc As Document)
    Dim rng As Range
    Set rng = doc.Content
    
    ' Clear any existing content if using a blank document
    If Not chkUseTemplate.Value Then
        rng.Text = ""
    End If
    
    ' Collapse to end to append content
    rng.Collapse Direction:=wdCollapseEnd
    
    ' Add letterhead and date if not using template
    If Not chkUseTemplate.Value Then
        ' Add simple letterhead
        rng.InsertAfter "STATEMENT OF WORK" & vbCrLf & vbCrLf
        
        ' Add date
        rng.InsertAfter txtDate.Value & vbCrLf & vbCrLf
        
        ' Add recipient information
        rng.InsertAfter txtContactName.Value & vbCrLf
        rng.InsertAfter txtCompanyName.Value & vbCrLf
        If Trim(txtAddress1.Value) <> "" Then
            rng.InsertAfter txtAddress1.Value & vbCrLf
        End If
        If Trim(txtAddress2.Value) <> "" Then
            rng.InsertAfter txtAddress2.Value & vbCrLf
        End If
        rng.InsertAfter vbCrLf
        
        ' Add subject line
        rng.InsertAfter "Subject: Statement of Work for Health & Benefits Services" & vbCrLf & vbCrLf
        
        ' Add salutation
        rng.InsertAfter "Dear " & txtContactName.Value & ":" & vbCrLf & vbCrLf
        
        ' Add opening paragraph
        rng.InsertAfter "This statement of work (""SOW"") will confirm the terms of the engagement of " & _
                      cmbWTWParty.Value & " (""WTW"", ""we"" or ""us"") by " & txtClientName.Value & _
                      " (""Client"" or ""you"")." & vbCrLf & vbCrLf
    End If
    
    ' Section I: Terms and Conditions
    rng.InsertAfter "I. Terms and Conditions of SOW:" & vbCrLf & vbCrLf
    rng.InsertAfter "Client desires to procure and WTW is willing to provide the services listed in Attachment 1 (the ""Services""). " & _
                  "These Services will be provided subject to the WTW Health & Benefits Brokerage Terms, Conditions & Disclosures available at: " & _
                  "https://www.wtwco.com/-/media/WTW/Notices/h-b-brokerage-terms-no-MSA.pdf (the ""Brokerage Terms""). " & _
                  "Copies of the Brokerage Terms are available upon request." & vbCrLf & vbCrLf
    
    ' Section II: Term and Termination
    rng.InsertAfter "II. Term and Termination:" & vbCrLf & vbCrLf
    rng.InsertAfter "The term of this SOW will begin on " & txtStartDate.Value & " and end on " & _
                  txtEndDate.Value & ". Either party may terminate this SOW upon 60 days prior written notice to the other party." & vbCrLf & vbCrLf
    
    ' Add auto-renewal if checked
    If chkAutoRenewal.Value Then
        rng.InsertAfter "Upon the expiration of the term, or any renewal term, this SOW will renew automatically for successive one-year terms " & _
                      "unless either party gives notice of non-renewal at least 60 days before the scheduled expiration date." & vbCrLf & vbCrLf
    End If
    
    ' Section III: Compensation
    rng.InsertAfter "III. Compensation" & vbCrLf & vbCrLf
    
    ' Insert appropriate compensation section based on selection
    If optA.Value Then
        InsertFeeOnly rng
    ElseIf optB.Value Then
        InsertFeePlusCommission rng
    ElseIf optC.Value Then
        InsertFeeOffset rng
    ElseIf optD.Value Then
        InsertCommissionOnly rng
    End If
    
    ' Section IV: Additional Terms
    rng.InsertAfter "IV. Additional Terms" & vbCrLf & vbCrLf
    
    ' Add GDPR clause if applicable
    If chkGDPR.Value Then
        rng.InsertAfter "The parties acknowledge that WTW may access personal data from Europe that could trigger GDPR requirements. " & _
                      "For Health & Benefits Brokerage services, WTW will act as a data controller in accordance with applicable " & _
                      "data protection laws." & vbCrLf & vbCrLf
    End If
    
    ' Add standard out-of-scope services paragraph
    rng.InsertAfter "If you would like us to vary the Services under this SOW, or to perform additional services that are not included, " & _
                  "please advise us. Also, if we believe certain services you have asked us to carry out are not within the defined scope, " & _
                  "we will promptly notify you. All out of scope services will be covered under a separate Statement of Work that will " & _
                  "specify the additional services that we will perform and the additional compensation that we will receive." & vbCrLf & vbCrLf
    
    ' Add any custom notes if provided
    If Trim(txtCustomNotes.Value) <> "" Then
        rng.InsertAfter "Additional Notes: " & txtCustomNotes.Value & vbCrLf & vbCrLf
    End If
    
    ' Add closing
    rng.InsertAfter "Please have an authorized representative of Client countersign below (and do the same in respect of the enclosed copies, " & _
                  "returning a set of countersigned documents to me for our records)." & vbCrLf & vbCrLf
    
    ' Add signature block
    rng.InsertAfter "IN WITNESS WHEREOF, the parties have executed this SOW effective as of the _____ day of _______________, 20__." & vbCrLf & vbCrLf
    
    rng.InsertAfter "Signed by and on behalf of " & cmbWTWParty.Value & vbCrLf & vbCrLf
    rng.InsertAfter "By: ____________________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Print name: _____________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Print title: _____________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Date: __________________________" & vbCrLf & vbCrLf
    
    rng.InsertAfter "Accepted and agreed on behalf of " & txtClientName.Value & vbCrLf & vbCrLf
    rng.InsertAfter "By: ____________________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Print name: _____________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Print title: _____________________" & vbCrLf & vbCrLf
    rng.InsertAfter "Date: __________________________" & vbCrLf & vbCrLf
    
    ' Add attachment reference for scope of services
    rng.InsertAfter "Attachments: Attachment 1 -- Scope of Services" & vbCrLf & vbCrLf
    
    ' Start Attachment 1
    rng.InsertAfter "Attachment 1" & vbCrLf & vbCrLf
    rng.InsertAfter "Services" & vbCrLf & vbCrLf
    
    ' Insert scope of services if provided
    If Trim(txtScopeOfServices.Value) <> "" Then
        rng.InsertAfter txtScopeOfServices.Value & vbCrLf
    Else
        rng.InsertAfter "[Attach Scope of Services]" & vbCrLf
    End If
    
    ' Format document
    FormatDocument doc
End Sub

' Insert fee-only compensation option
Private Sub InsertFeeOnly(rng As Range)
    rng.InsertAfter "You agree that our compensation for the Services will be an annual fee of $" & _
                  FormatNumber(txtAnnualFee.Value, 2, vbTrue, vbFalse, vbTrue) & ", payable by you to us as follows." & vbCrLf & vbCrLf
    
    ' Insert billing details
    InsertBillingDetails rng
    
    ' Insert expenses paragraph
    InsertExpensesParagraph rng
    
    ' Insert fee statement
    rng.InsertAfter "The fee is in addition to the premiums you must pay for your policies. " & _
                  "Information regarding other compensation we may receive is described in the Brokerage Terms." & vbCrLf & vbCrLf
    
    ' Insert earned fee table
    InsertEarnedFeeTable rng
End Sub

' Insert fee plus commission option
Private Sub InsertFeePlusCommission(rng As Range)
    rng.InsertAfter "You agree that our compensation for the Services will be an annual fee of $" & _
                  FormatNumber(txtAnnualFee.Value, 2, vbTrue, vbFalse, vbTrue) & ", payable by you to us as follows." & vbCrLf & vbCrLf
    
    ' Insert billing details
    InsertBillingDetails rng
    
    ' Insert expenses paragraph
    InsertExpensesParagraph rng
    
    ' Insert fee statement
    rng.InsertAfter "The fee is in addition to the premiums you must pay for your policies. " & _
                  "Information regarding other compensation we may receive is described in the Brokerage Terms." & vbCrLf & vbCrLf
    
    ' Insert commission paragraph
    rng.InsertAfter "You also agree that, in addition to the fee, we will be entitled to compensation in the form of " & _
                  "commissions paid to us by insurers for the sale of the following insurance policies:" & vbCrLf & vbCrLf
    
    ' Insert policy list
    InsertPolicyList rng
    
    ' Insert additional explanation
    rng.InsertAfter "To the extent that we receive both fees and commissions for Services related to the same insurance policies, " & _
                  "the commissions compensate us for the placement and servicing of those policies, while the fee compensates us " & _
                  "for the Services which are in addition to the placement and routine servicing of the policies." & vbCrLf & vbCrLf
    
    ' Insert commission adjustment clause
    rng.InsertAfter "The parties agree that should the commissions increase or decrease by an amount exceeding ten percent (10%), " & _
                  "due to a change in covered lives, added or deleted policies or for other reasons, the parties will discuss " & _
                  "changes to our compensation and/or Services. Any such changes will be agreed to in writing by the parties." & vbCrLf & vbCrLf
    
    ' Insert earned fee table
    InsertEarnedFeeTable rng
End Sub

' Insert fee offset by commission option
Private Sub InsertFeeOffset(rng As Range)
    rng.InsertAfter "You agree that our compensation for the Services will be an annual fee of $" & _
                  FormatNumber(txtAnnualFee.Value, 2, vbTrue, vbFalse, vbTrue) & ", payable by you to us as follows." & vbCrLf & vbCrLf
    
    ' Insert billing details
    InsertBillingDetails rng
    
    ' Insert expenses paragraph
    InsertExpensesParagraph rng
    
    ' Insert fee statement
    rng.InsertAfter "The fee is in addition to the premiums you must pay for your policies. " & _
                  "Information regarding other compensation we may receive is described in the Brokerage Terms." & vbCrLf & vbCrLf
    
    ' Insert offset paragraph
    rng.InsertAfter "To the extent that we also receive during the term of this SOW commissions paid by insurers for the sale of " & _
                  "the insurance policies that you purchase, we will use those base commissions to offset our fee, but only to " & _
                  "the extent allowable by law. You acknowledge that we cannot return commissions to you under any circumstance. " & _
                  "We will account to you periodically during the term of the SOW and at the termination of the SOW for all " & _
                  "commissions received." & vbCrLf & vbCrLf
    
    ' Insert policy list
    InsertPolicyList rng
    
    ' Insert earned fee table
    InsertEarnedFeeTable rng
End Sub

' Insert commission-only option
Private Sub InsertCommissionOnly(rng As Range)
    rng.InsertAfter "You agree that we will be compensated by commissions paid to us by insurers for the sale of the insurance policies " & _
                  "that you purchase. All commissions will be fully disclosed to you prior to our placing coverage. The commissions " & _
                  "will be earned for the entire policy period at the time we place insurance policies for you." & vbCrLf & vbCrLf
    
    ' Insert policy list
    InsertPolicyList rng
    
    ' Insert commission adjustment clause
    rng.InsertAfter "The parties agree that should commissions increase or decrease by an amount exceeding ten percent (10%), " & _
                  "due to a change in covered lives, added or deleted policies or for other reasons, the parties will discuss " & _
                  "changes to our compensation and/or Services. Any such changes will be agreed to in writing by the parties." & vbCrLf & vbCrLf
    
    ' Insert additional information
    rng.InsertAfter "Information regarding other compensation we may receive is described in the Brokerage Terms." & vbCrLf & vbCrLf
End Sub

' Insert billing details based on selection
Private Sub InsertBillingDetails(rng As Range)
    If optMilestone.Value Then
        rng.InsertAfter "in installments with 30% of the fee due upon execution of this statement of work, 50% of the fee due at the " & _
                      "completion of the plan selection, and 20% of the fee due upon completion of our Services." & vbCrLf & vbCrLf
    ElseIf optInstallments.Value Then
        rng.InsertAfter "at the beginning of each quarter (or month, or in equal installments over the period of the project " & _
                      "if shorter than a year) beginning with the execution of this SOW." & vbCrLf & vbCrLf
    End If
End Sub

' Insert expenses paragraph
Private Sub InsertExpensesParagraph(rng As Range)
    rng.InsertAfter "In addition to the fee, our charges will include the following:" & vbCrLf & vbCrLf
    
    rng.InsertAfter "• reimbursement, at cost, of direct expenses reasonably incurred by us in connection with the performance " & _
                  "of our Services, such as travel and other vendor expenses, and itemized extraordinary expenses such as " & _
                  "large-volume color printing, large-volume courier shipments and the like, plus an administrative fee of 5% " & _
                  "of any vendor charges other than travel, unless arrangements are made in advance for charges to be invoiced " & _
                  "to and paid by you directly; and" & vbCrLf & vbCrLf
    
    rng.InsertAfter "• the amount of any tax or similar assessment based upon our charges." & vbCrLf & vbCrLf
    
    rng.InsertAfter "We will bill you for the fee payments as they become due. At the end of each month during which we perform " & _
                  "Services for you, we will also bill you for all other charges accrued for the month, such as travel and " & _
                  "vendor expenses." & vbCrLf & vbCrLf
End Sub

' Insert policy list from listbox
Private Sub InsertPolicyList(rng As Range)
    Dim i As Integer
    
    For i = 0 To lstPolicies.ListCount - 1
        rng.InsertAfter "• " & lstPolicies.List(i) & vbCrLf
    Next i
    
    rng.InsertAfter vbCrLf
End Sub

' Insert earned fee table for options A, B, and C
Private Sub InsertEarnedFeeTable(rng As Range)
    rng.InsertAfter "You acknowledge that, even though we may regularly invoice you on a different schedule during the term of this " & _
                  "SOW, a substantial portion of our work is provided prior to and at the effective date of your benefit plan. " & _
                  "Therefore, if this SOW is terminated before the end of the term, in order to compensate us fully for the " & _
                  "services actually provided to you, the parties agree that the fee is earned and that you will pay us as " & _
                  "provided in the following table:" & vbCrLf & vbCrLf
    
    ' Insert table (simplified for text output)
    rng.InsertAfter "Strategic Planning                15%     Earned in equal monthly installments prior to the benefit plan" & vbCrLf
    rng.InsertAfter "                                          effective date (fully earned at benefit plan effective date)" & vbCrLf & vbCrLf
    
    rng.InsertAfter "Program Renewal /                35%     Earned in equal monthly installments prior to the benefit plan" & vbCrLf
    rng.InsertAfter "Placement Process                        effective date (fully earned at benefit plan effective date)" & vbCrLf & vbCrLf
    
    rng.InsertAfter "Ongoing Service and              50%     Earned in 12 equal monthly installments (starting at benefit" & vbCrLf
    rng.InsertAfter "Resources                                plan effective date)" & vbCrLf & vbCrLf
End Sub

' Format document with proper styles
Private Sub FormatDocument(doc As Document)
    ' Apply appropriate styling if needed
    ' This is a basic implementation; you can enhance as required
    With doc
        .Paragraphs.Format.SpaceAfter = 6
        .Paragraphs.Format.SpaceBefore = 0
    End With
End Sub

' Cancel button
Private Sub btnCancel_Click()
    Unload Me
End Sub
